/*!
 * Cirquity - Cirquity v0.1.0 (https://cirquity.com)
 * Copyright 2020-2020 The Cirquity Developers
 * Licensed under MIT (https://github.com/cirquity/cirquity-pool/blob/master/LICENSE)
 */

!function(t){let o=!1,e=!1,l={},a={};t((function(){currentPage={destroy:function(){},update:function(o){e&&t.updateBlocks(o)}};let s=setInterval((function(){lastStats&&(t.blocksInitTemplate(o,l,a),t.loadTranslations(),clearInterval(s))}),10)})),t.updateBlocks=function(o){let e=o===parentCoin?lastStats:mergedStats[o];e&&(l[o]=!1,e.charts.blocks&&t.blocksGenerateChart(e,l),t.blocksRenderBlocks(e.pool.blocks,e))},t.blocksInitTemplate=function(l,a,s){let n=lastStats.config.coin;if(0===t(`#blocksTabs li:contains(${n})`).length){let o=t("#siblingTemplate").html();Mustache.parse(o);let e=Mustache.render(o,{coin:lastStats.config.coin,active:"active"});t("#blocksContent").append(e);let l=t("#siblingTabTemplate").html();Mustache.parse(l);let a=Mustache.render(l,{coin:lastStats.config.coin,symbol:`(${lastStats.config.symbol})`,active:"active"});t("#blocksTabs").append(a),t.blocksSetup(api,lastStats,s)}if(t.updateText(`blocksTotal${n}`,lastStats.pool.totalBlocks.toString()),lastStats.pool.lastBlockFound){const o=new Date(parseInt(lastStats.pool.lastBlockFound)).toISOString();t(`#lastBlockFound${n}`).timeago("update",o)}else t(`#lastBlockFound${n}`).removeAttr("title").data("ts","").update("Never");if(t.updateText(`blocksTotalSolo${n}`,lastStats.pool.totalBlocksSolo.toString()),lastStats.pool.lastBlockFoundSolo){const o=new Date(parseInt(lastStats.pool.lastBlockFoundSolo)).toISOString();t(`#lastBlockFoundSolo${n}`).timeago("update",o)}else t(`#lastBlockFoundSolo${n}`).removeAttr("title").data("ts","").update("Never");t.updateText(`blocksMaturityCount${n}`,lastStats.config.depth.toString()),t(`#averageLuck${n}`).html(t.formatLuck(lastStats.pool.totalDiff,lastStats.pool.totalShares)),a[lastStats.config.coin]=!1,lastStats.charts.blocks&&t.blocksGenerateChart(lastStats,a),t.blocksRenderBlocks(lastStats.pool.blocks,lastStats),Object.keys(mergedStats).forEach(o=>{if(0===t(`#blocksTabs li:contains(${o})`).length){let e=t("#siblingTemplate").html();Mustache.parse(e);let l=Mustache.render(e,{coin:o});t("#blocksContent").append(l);let a=t("#siblingTabTemplate").html();Mustache.parse(a);let s=Mustache.render(a,{coin:o,symbol:`(${mergedStats[o].config.symbol})`});t("#blocksTabs").append(s),t.blocksSetup(mergedApis[o].api,mergedStats[o])}if(t.updateText(`blocksTotal${o}`,mergedStats[o].pool.totalBlocks.toString()),mergedStats[o].pool.lastBlockFound){const e=new Date(parseInt(mergedStats[o].pool.lastBlockFound)).toISOString();t(`#lastBlockFound${o}`).timeago("update",e)}else t(`#lastBlockFound${o}`).removeAttr("title").data("ts","").update("Never");if(t.updateText(`blocksTotalSolo${o}`,mergedStats[o].pool.totalBlocksSolo.toString()),mergedStats[o].pool.lastBlockFoundSolo){const e=new Date(parseInt(mergedStats[o].pool.lastBlockFoundSolo)).toISOString();t(`#lastBlockFoundSolo${o}`).timeago("update",e)}else t(`#lastBlockFoundSolo${o}`).removeAttr("title").data("ts","").update("Never");t.updateText(`blocksMaturityCount${o}`,mergedStats[o].config.depth.toString()),t(`#averageLuck${o}`).html(t.formatLuck(mergedStats[o].pool.totalDiff,mergedStats[o].pool.totalShares)),a[o]=!1,mergedStats[o].charts.blocks&&t.blocksGenerateChart(mergedStats[o],a),t.blocksRenderBlocks(mergedStats[o].pool.blocks,mergedStats[o])}),t.sortElementList(t("#blocksTabs"),t("#blocksTabs > div"),mergedStats),l||(o=t.blocksRunOnce()),e=!0},t.blocksRenderBlocks=function(o,e){let l=t(`#blocksReport${e.config.coin}_rows`);for(let a=0;a<o.length;a+=2){let s=t.blocksParseBlock(o[a+1],o[a],e),n=JSON.stringify(s),c=document.getElementById(`blockRow${e.config.coin}${s.height}`);if(c&&c.getAttribute("data-json")!==n)t(c).replaceWith(t.blocksGetBlockRowElement(s,n,e));else if(!c){let o=t.blocksGetBlockRowElement(s,n,e),a=!1,c=l.children().get();for(let e=0;e<c.length;e++){if(parseInt(c[e].getAttribute("data-height"))<s.height){a=!0,t(c[e]).before(o);break}}a||l.append(o)}}},t.blocksGetBlockRowElement=function(o,e,l){let a=document.createElement("tr");a.setAttribute("data-json",e),a.setAttribute("data-height",o.height),a.setAttribute("id",`blockRow${l.config.coin}${o.height}`),a.setAttribute("title",o.status),a.className={pending:"pending",unlocked:"unlocked",orphaned:"orphaned"}[o.status];let s="",n="success";return void 0===o.reward?(s="Waiting...",n="warning"):(s=t.getReadableCoin(l,o.reward,null,!0),"0"===s&&(n="danger")),console.log(o.height),a.innerHTML='<td class="col1">'+t.timeago(new Date(1e3*parseInt(o.time)).toISOString())+'</td><td class="col2"><span class="badge badge-'+n+'">'+s+'</span></td><td class="col3">'+o.height+'</td><td class="col4">'+o.difficulty+'</td><td class="col5">'+t.formatBlockLink(o.hash,l)+'</td><td class="col5" title="Miners Address">'+o.address+'</td><td class="col6" title="'+o.shares+' shares submitted">'+t.formatLuck(o.difficulty,o.shares,o.solo)+'</td><td class="col7">'+o.maturity+"</td>",a},t.blocksGenerateChart=function(o,e){if(e[o.config.coin]||!o.charts.blocks||"undefined"===o.charts.blocks||!o.charts.blocksSolo||"undefined"===o.charts.blocksSolo)return;let l=o.config.blocksChartDays||null,a=t.getTranslation("poolBlocks")?t.getTranslation("poolBlocks"):"Blocks found";l&&(a=1===l?t.getTranslation("blocksFoundLast24")?t.getTranslation("blocksFoundLast24"):"Blocks found in the last 24 hours":t.getTranslation("blocksFoundLastDays")?t.getTranslation("blocksFoundLastDays"):"Blocks found in the last {DAYS} days",a=a.replace("{DAYS}",l)),t.updateText(`blocksChartTitle${o.config.coin}`,a);let s=[],n=[],c=[];for(let t in o.charts.blocks){let e=t;if(l&&1===l){e=t.split(" ")[1].replace(":00","")}s.push(e),n.push(o.charts.blocks[t])}for(let t in o.charts.blocksSolo)c.push(o.charts.blocksSolo[t]);let r=null,i=null,d=null,u=t(`blocksChartObj${o.config.coin}`).siblings("a.chart-style");1===u.length&&(r=u.css("background-color"),i=u.css("border-left-color"),d=parseFloat(u.css("width"))),null===r&&(r="rgba(3, 169, 244, .4)"),null===i&&(i="#03a9f4"),(null===d||isNaN(d))&&(d=1);let k=document.getElementById(`blocksChartObj${o.config.coin}`);if(!k)return;new Chart(k,{type:"bar",data:{labels:s,datasets:[{label:"Prop Blocks",data:n,fill:!1,backgroundColor:r,borderColor:i,borderWidth:d},{label:"Solo Blocks",data:c,fill:!1,backgroundColor:"rgba(0, 230, 64, 1)",borderColor:i,borderWidth:d}]},options:{responsive:!0,maintainAspectRatio:!1,legend:{display:!1},scales:{yAxes:[{ticks:{beginAtZero:!0,userCallback:function(t,o,e){if(Math.floor(t)===t)return t}}}]},layout:{padding:{top:0,left:0,right:0,bottom:0}}}});t(`#blocksChart${o.config.coin}`).show(),e[o.config.coin]=!0},t.blocksParseBlock=function(t,o,e){let l=o.split(":"),a={};a=l[0].includes("solo")||l[0].includes("prop")?{height:parseInt(t),solo:"solo"===l[0],address:l[1],hash:l[2],time:l[3],difficulty:parseInt(l[4]),shares:parseInt(l[5]),orphaned:l[6],reward:l[7]}:{height:parseInt(t),solo:!1,address:"",hash:l[0],time:l[1],difficulty:parseInt(l[2]),shares:parseInt(l[3]),orphaned:l[4],reward:l[5]};let s=e.config.depth-(e.network.height-a.height-1);switch(s>1?a.maturity=s+" to go":1===s?a.maturity="<i class='fa fa-spinner fa-spin'></i>":s<=0&&(a.maturity="<i class='fa fa-unlock-alt'></i>"),a.orphaned){case"0":a.status="unlocked",a.maturity="<i class='fa fa-unlock-alt'></i>";break;case"1":a.status="orphaned",a.maturity="<i class='fa fa-times'></i>",a.reward=0;break;default:a.status="pending"}return a},t.blocksSetup=function(o,e,l){t(`#loadMoreBlocks${e.config.coin}`).click((function(l){l[e.config.coin]&&l[e.config.coin].abort(),l[e.config.coin]=t.ajax({url:o+"/get_blocks",data:{height:t(`#blocksReport${e.config.coin}_rows`).children().last().data("height")},dataType:"json",cache:"false",success:function(o){t.blocksRenderBlocks(o,e)}})}))},t.blocksRunOnce=function(){return t("#blocksTabs a").click((function(o){o.preventDefault(),t(this).tab("show")})),!0}}(jQuery);